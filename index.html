<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini Chat â€” Firebase</title>
    <style>
        /* CSS Variables & Global Styles */
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #9ca3af;
            --text: #e5e7eb;
            --brand: #22c55e;
            --danger: #ef4444;
            --accent: #3b82f6;
            --radius: 14px;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: linear-gradient(180deg, #0b1022, #0f172a 20%);
            font-family: system-ui, sans-serif;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* App Container & Layout */
        .app {
            width: 100%;
            max-width: 1100px;
            min-height: 70vh;
            background: #0b1222aa;
            backdrop-filter: blur(8px);
            border: 1px solid #1f2937;
            border-radius: var(--radius);
            display: grid;
            grid-template-columns: 320px 1fr;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, .5);
        }

        /* Sidebar & Header */
        .sidebar {
            background: var(--panel);
            border-right: 1px solid #1f2937;
            display: flex;
            flex-direction: column;
        }
        .brand {
            padding: 18px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand h1 { font-size: 18px; margin: 0; }

        /* Auth & User Info */
        .auth, .me {
            padding: 16px;
            border-bottom: 1px solid #1f2937;
        }
        .row { display: flex; gap: 8px; }

        /* Form Elements & Buttons */
        input {
            background: #0b1022;
            border: 1px solid #1f2937;
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            width: 100%;
        }
        button {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        button.secondary { background: #334155; }
        button.danger { background: var(--danger); }
        small { color: var(--muted); }

        /* User List */
        .users { flex: 1; overflow-y: auto; }
        .users h3 {
            font-size: 12px;
            color: var(--muted);
            padding: 10px 16px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: .15em;
        }
        .user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #111827;
        }
        .user:hover { background: #0b1022; }

        /* Avatar */
        .avatar {
            background: #1f2937;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .user .meta { display: flex; flex-direction: column; }
        .user .meta .name { font-weight: 600; }
        .user .meta .email {
            font-size: 12px;
            color: var(--muted);
        }

        /* Chat Panel */
        .chat {
            display: flex;
            flex-direction: column;
            background: radial-gradient(1200px 400px at 10% -10%, #0b1431, transparent);
        }
        .chat-header {
            padding: 14px 16px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .peer { display: flex; align-items: center; gap: 10px; }
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 40 40"><g fill="%231f2937" fill-opacity=".45"><circle cx="1" cy="1" r="1"/><circle cx="21" cy="21" r="1"/><circle cx="1" cy="21" r="1"/><circle cx="21" cy="1" r="1"/></g></svg>');
        }
        
        /* Message Bubbles */
        .bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid #1f2937;
            background: #0b1022;
        }
        .me-bubble {
            margin-left: auto;
            background: #12234c;
            border-color: #1f3a8a;
        }
        .stamp {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            color: #93a3b8;
            text-align: right;
            line-height: 1;
        }
        .me-bubble .stamp {
            color: #b0c9f1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        /* Composer */
        .composer {
            display: flex;
            gap: 10px;
            padding: 12px;
            border-top: 1px solid #1f2937;
        }
        .composer input { flex: 1; }
        
        /* Empty States */
        .empty {
            margin: auto;
            color: #93a3b8;
            text-align: center;
            max-width: 460px;
            padding: 20px;
        }
        .pill {
            font-size: 12px;
            background: #0b1022;
            border: 1px solid #1f2937;
            color: #93a3b8;
            padding: 6px 10px;
            border-radius: 999px;
        }

        /* Mobile Responsiveness */
        #menuBtn { display: none; }
        @media (max-width: 960px) {
            .app { grid-template-columns: 1fr; }
            .sidebar {
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: 2;
                display: none;
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.active {
                display: flex;
                transform: translateX(0);
            }
            .chat {
                width: 100%;
                height: 100%;
            }
            #menuBtn {
                display: flex;
                background: #334155;
                font-size: 20px;
                padding: 6px 10px;
            }
        }
        /* Chat Panel */
.chat {
    display: flex;
    flex-direction: column;
    background: radial-gradient(1200px 400px at 10% -10%, #0b1431, transparent);
    position: relative;
    height: 100%;
}

/* Chat Header stays on top (desktop + mobile) */
.chat-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--panel);
    padding: 14px 16px;
    border-bottom: 1px solid #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Chat Body scrolls between header and composer */
.chat-body {
    flex: 1;
    overflow-y: auto;
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 40 40"><g fill="%231f2937" fill-opacity=".45"><circle cx="1" cy="1" r="1"/><circle cx="21" cy="21" r="1"/><circle cx="1" cy="21" r="1"/><circle cx="21" cy="1" r="1"/></g></svg>');
}

/* Composer stays at bottom (desktop + mobile) */
.composer {
    position: sticky;
    bottom: 0;
    z-index: 10;
    background: var(--panel);
    display: flex;
    gap: 10px;
    padding: 12px;
    border-top: 1px solid #1f2937;
}

/* Mobile Responsiveness */
#menuBtn { display: none; }

@media (max-width: 960px) {
    .app { grid-template-columns: 1fr; }

    .sidebar {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 20;
        display: none;
        transition: transform 0.3s ease-in-out;
    }
    .sidebar.active {
        display: flex;
        transform: translateX(0);
    }

    .chat {
        width: 100%;
        height: 100%;
    }

    #menuBtn {
        display: flex;
        background: #334155;
        font-size: 20px;
        padding: 6px 10px;
    }
}

    </style>
</head>
<body>

<div class="app">
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <h1>Mini Chat</h1>
            <button id="logoutBtn" class="secondary">Logout</button>
        </div>
        <div class="auth" id="authBox">
            <div class="row"><input id="email" type="email" placeholder="Email"></div>
            <div class="row"><input id="password" type="password" placeholder="Password (6+ chars)"></div>
            <div class="row">
                <button id="loginBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-in"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                    Login
                </button>
                <button id="signupBtn" class="secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-plus"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                    Sign Up
                </button>
            </div>
            <small id="authMsg"></small>
        </div>
        <div class="me" id="meBox" style="display:none">
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="avatar" id="meAvatar">ðŸ‘¤</div>
                <div>
                    <div id="meName" style="font-weight:700">â€”</div>
                    <div id="meEmail" class="muted">â€”</div>
                </div>
            </div>
            <small class="muted">Tip: open in 2 browsers and test.</small>
        </div>
        <div class="users" id="usersPane">
            <h3>People</h3>
            <div id="userList"></div>
        </div>
    </aside>

    <section class="chat">
        <div class="chat-header">
            <button id="menuBtn">â˜°</button>
            <div class="peer">
                <div class="avatar" id="peerAvatar">ðŸ’¬</div>
                <div>
                    <div id="peerName" style="font-weight:700">Select a user</div>
                    <div id="peerEmail" class="muted"></div>
                </div>
            </div>
            <span id="chatBadge" class="pill">no chat</span>
        </div>
        <div class="chat-body" id="messages">
            <div class="empty">
                <h3>Welcome!</h3>
                <p>Login or sign up to get started, then select a user from the sidebar to begin chatting.</p>
            </div>
        </div>
        <div class="composer">
            <input id="messageInput" type="text" placeholder="Type a messageâ€¦">
            <button id="sendBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                Send
            </button>
        </div>
    </section>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    // 1. Firebase Configuration & Initialization
    const firebaseConfig = {
        apiKey: "AIzaSyDLGiXGuLpj7W3F9xVPbHEcoivBbu0EL3E",
        authDomain: "form-25.firebaseapp.com",
        projectId: "form-25",
        storageBucket: "form-25.firebasestorage.app",
        messagingSenderId: "1040102030890",
        appId: "1:1040102030890:web:95a0fdf665f546e7290d53",
        measurementId: "G-JRL01JQLK1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. DOM Elements
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authBox = document.getElementById('authBox');
    const meBox = document.getElementById('meBox');
    const meName = document.getElementById('meName');
    const meEmail = document.getElementById('meEmail');
    const meAvatar = document.getElementById('meAvatar');
    const userList = document.getElementById('userList');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const peerName = document.getElementById('peerName');
    const peerEmail = document.getElementById('peerEmail');
    const peerAvatar = document.getElementById('peerAvatar');
    const chatBadge = document.getElementById('chatBadge');
    const authMsg = document.getElementById('authMsg');
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menuBtn');
    
    let currentUser = null;
    let selectedPeer = null;
    let unsubscribeMessages = null;

    // 3. Helper Functions
    function showError(el, msg) {
        el.textContent = msg;
        setTimeout(() => el.textContent = '', 4000);
    }
    const makeChatId = (a, b) => a < b ? `${a}_${b}` : `${b}_${a}`;

    // 4. Authentication Logic
    signupBtn.onclick = async () => {
        try {
            const { user } = await auth.createUserWithEmailAndPassword(emailEl.value.trim(), passEl.value);
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                name: user.email.split('@')[0],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (err) { showError(authMsg, err.message); }
    };
    loginBtn.onclick = async () => {
        try { await auth.signInWithEmailAndPassword(emailEl.value.trim(), passEl.value); }
        catch (err) { showError(authMsg, err.message); }
    };
    logoutBtn.onclick = () => auth.signOut();
    
    auth.onAuthStateChanged(async (user) => {
        currentUser = user || null;
        if (!currentUser) {
            authBox.style.display = 'block';
            meBox.style.display = 'none';
            userList.innerHTML = '';
            messages.innerHTML = `<div class="empty"><h3>Welcome!</h3><p>Login or sign up to get started, then select a user from the sidebar to begin chatting.</p></div>`;
            chatBadge.textContent = 'no chat';
            meAvatar.textContent = 'ðŸ‘¤';
            peerAvatar.textContent = 'ðŸ’¬';
            peerName.textContent = 'Select a user';
            peerEmail.textContent = '';
            return;
        }

        // Show signed-in UI
        authBox.style.display = 'none';
        meBox.style.display = 'block';
        const myName = currentUser.email.split('@')[0];
        meName.textContent = myName;
        meEmail.textContent = currentUser.email;
        meAvatar.textContent = myName.charAt(0).toUpperCase();

        await db.collection('users').doc(currentUser.uid).set({
            uid: currentUser.uid,
            email: currentUser.email,
            name: myName,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Load list of all users
        db.collection('users').orderBy('createdAt', 'desc').onSnapshot(snap => {
            userList.innerHTML = '';
            snap.forEach(doc => {
                const u = doc.data();
                if (!u.uid || u.uid === currentUser.uid) return;
                const div = document.createElement('div');
                div.className = 'user';
                div.innerHTML = `<div class="avatar">${u.name.charAt(0).toUpperCase()}</div>
                    <div class="meta"><span class="name">${u.name}</span><span class="email">${u.email}</span></div>`;
                div.onclick = () => openChatWith(u);
                userList.appendChild(div);
            });
        });
    });

    // 5. Chat Functions
    async function openChatWith(peer) {
        selectedPeer = peer;
        peerName.textContent = peer.name;
        peerEmail.textContent = peer.email;
        peerAvatar.textContent = peer.name.charAt(0).toUpperCase();
        chatBadge.textContent = 'chatting';
        
        // Hide sidebar on mobile after selecting a user
        if (window.innerWidth < 960) {
            sidebar.classList.remove('active');
        }

        const chatId = makeChatId(currentUser.uid, peer.uid);
        const chatRef = db.collection('chats').doc(chatId);
        if (!(await chatRef.get()).exists) {
            await chatRef.set({ participants: [currentUser.uid, peer.uid], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        
        if (unsubscribeMessages) unsubscribeMessages();
        unsubscribeMessages = chatRef.collection('messages').orderBy('timestamp').onSnapshot(snap => {
            messages.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                const me = m.senderId === currentUser.uid;
                const bubble = document.createElement('div');
                bubble.className = 'bubble ' + (me ? 'me-bubble' : '');
                
                const timestampText = new Date(m.timestamp?.toDate?.() || Date.now()).toLocaleTimeString();
                
                // Add checkmark for sent messages
                const checkmark = me ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#b0c9f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>` : '';
                
                bubble.innerHTML = `<div>${m.text}</div><span class="stamp">${timestampText} ${checkmark}</span>`;
                messages.appendChild(bubble);
            });
            messages.scrollTop = messages.scrollHeight;
        });
    }

    sendBtn.onclick = async () => {
        if (!currentUser || !selectedPeer) return;
        const text = messageInput.value.trim();
        if (!text) return;
        const chatId = makeChatId(currentUser.uid, selectedPeer.uid);
        await db.collection('chats').doc(chatId).collection('messages').add({
            text, senderId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = '';
    };
    
    // Send message on Enter key press
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { 
            e.preventDefault(); 
            sendBtn.click(); 
        }
    });

    // Mobile menu button toggle
    menuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });
</script>
</body>
</html>
